# Runtime Image - SteamCMD

Docker image for **runtime execution** of game servers in Pterodactyl Panel.

## Purpose

This image runs and executes game servers after installation. It includes an entrypoint script that handles:
- Pterodactyl STARTUP command processing
- Optional automatic updates via SteamCMD
- Environment variable substitution
- Server startup and signal handling

## Image Details

**Tags:**
- `fabriciojrsilva/steamcmd-eggs:latest` (recommended)
- `fabriciojrsilva/steamcmd-eggs:arma-reforger` (game-specific)

**Base:** `debian:bookworm-slim`

**Size:** ~250MB

**User:** `container` (UID 1000, non-privileged)

## What's Included

- **32-bit Libraries:** `lib32gcc-s1`, `lib32stdc++6` (required for SteamCMD)
- **Core Tools:** `curl`, `tar`, `jq`, `ca-certificates`
- **Networking:** `iproute2`, `iputils-ping`, `net-tools`, `netcat-traditional`
- **Process Management:** `procps`
- **Memory Optimization:** `libjemalloc2` (for better memory management)
- **Locale:** UTF-8 support
- **Entrypoint:** `entrypoint.sh` for startup automation

## How It Works

1. **Pterodactyl starts the server** (user clicks "Start")
2. **Wings creates container** from `fabriciojrsilva/steamcmd-eggs:latest`
3. **Mounts volumes:**
   - `/home/container` - Server files (from `/mnt/server` on host)
   - Environment variables passed by Pterodactyl
4. **Runs entrypoint:** `/entrypoint.sh`
5. **Entrypoint performs:**
   - Sets up time zone and network configuration
   - Processes `STARTUP` variable (replaces `{{VAR}}` with values)
   - **Optional:** Runs SteamCMD auto-update if `AUTO_UPDATE=1`
   - Executes the STARTUP command
6. **Game server runs** until stopped

## Building

```bash
docker build -t fabriciojrsilva/steamcmd-eggs:latest -t fabriciojrsilva/steamcmd-eggs:arma-reforger .
```

## Pushing

```bash
docker push fabriciojrsilva/steamcmd-eggs:latest
docker push fabriciojrsilva/steamcmd-eggs:arma-reforger
```

## Environment Variables (runtime)

These are passed by Pterodactyl during server execution:

| Variable | Description | Example |
|----------|-------------|---------|
| `STARTUP` | Command to start server | `cd /home/container && bash armareforger-server.sh` |
| `MODIFIED_STARTUP` | Startup with substituted variables | (auto-generated by Pterodactyl) |
| `AUTO_UPDATE` | Enable SteamCMD updates | `0` or `1` |
| `STEAM_USER` | Steam username | `anonymous` |
| `STEAM_PASS` | Steam password | (blank for anon) |
| `STEAM_AUTH` | Steam auth code (2FA) | (optional) |
| `SRCDS_APPID` | Steam App ID | `1874900` |
| `TZ` | Time zone | `UTC` (default) |

### Pterodactyl Variable Substitution

The entrypoint converts Pterodactyl's template format to shell variables:

```bash
# Input (from STARTUP variable):
{{server.build.default.port}}    â†’    ${server.build.default.port}

# Then substituted by Pterodactyl into MODIFIED_STARTUP
```

## Entrypoint Script

The `entrypoint.sh` script:

```bash
# 1. Wait for system initialization
sleep 1

# 2. Set timezone and network config
TZ=${TZ:-UTC}
INTERNAL_IP=$(ip route get 1 | awk '{print $(NF-2);exit}')

# 3. Change to server directory
cd /home/container || exit 1

# 4. Parse STARTUP variable
PARSED=$(echo "${STARTUP}" | sed -e 's/{{/${/g' -e 's/}}/}/g' | eval echo "$(cat -)")

# 5. Default steam user to anonymous
if [ "${STEAM_USER}" == "" ]; then
    STEAM_USER=anonymous
fi

# 6. Optional auto-update (if AUTO_UPDATE=1)
if [ -z ${AUTO_UPDATE} ] || [ "${AUTO_UPDATE}" == "1" ]; then
    ./steamcmd/steamcmd.sh \
        +force_install_dir /home/container \
        +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} \
        +app_update ${SRCDS_APPID} validate \
        +quit
fi

# 7. Execute the parsed startup command
exec env ${PARSED}
```

## Auto-Update Feature

To enable automatic server updates on each start:

1. **In Pterodactyl Panel:**
   - Edit server variables
   - Set `AUTO_UPDATE` to `1`
   - Save

2. **On next server start:**
   - SteamCMD runs: `+app_update 1874900 validate +quit`
   - Updated files downloaded (if available)
   - Server starts with latest files

3. **To disable:** Set `AUTO_UPDATE` to `0`

## Signal Handling

The entrypoint uses proper process management via the CMD/ENTRYPOINT structure. Signals (SIGTERM, SIGINT) are properly passed to the game server process for graceful shutdown.

## Example Startup Sequence

```
$ docker run -e STARTUP="bash armareforger-server.sh" fabriciojrsilva/steamcmd-eggs:latest

# Output from entrypoint:
steam user is not set.

Using anonymous user.

Starting Pterodactyl Container...
User:      container (UID: 1000)
Home:      /home/container
Workdir:   /home/container

Steam user set to anonymous

Auto-update disabled (AUTO_UPDATE=0). Starting server...

container@pterodactyl~ bash armareforger-server.sh

# Server startup script output:
==========================================
Arma Reforger Dedicated Server
==========================================
Server:   Arma Reforger Server
Players:  64
Scenario: {ECC61978EDCC2B5A}Missions/23_Campaign.conf
Port:     2001

Starting Arma Reforger Server...
```

## Performance Optimization

- **Non-privileged user:** Runs as `container` (UID 1000) for security
- **Lightweight base:** Uses `debian:bookworm-slim` instead of full Debian
- **Minimal packages:** Only installs required dependencies
- **SteamCMD caching:** Previously downloaded files are reused

## Troubleshooting

### No STARTUP command defined

```
ERROR: No STARTUP command defined!
  STARTUP: <not defined>
  MODIFIED_STARTUP: <not defined>

Check the egg configuration in the Pterodactyl Panel.
```

**Solution:** Verify egg JSON has `startup` field:
```json
"startup": "cd /home/container && bash armareforger-server.sh"
```

### ArmaReforgerServer binary not found

```
(MISSING) ArmaReforgerServer NOT found
```

**Solution:** Run **Reinstall** in Pterodactyl Panel to download files using the installer image.

### Permission denied

```
/home/container: Permission denied
```

**Solution:** Check that files are owned by `container` user. Run Reinstall to fix permissions.

## Related

- [Installer Image](../installer/README.md) - Used during installation
- [Entrypoint Script](entrypoint.sh) - Startup automation
- [Egg Configuration](../../eggs/arma-reforger/README.md) - Full egg docs
| `SRCDS_APPID` | Steam App ID for the game | `1874900` |
| `STEAM_USER` | Steam username for login | `anonymous` |
| `STEAM_PASS` | Steam password | (empty) |
| `STEAM_AUTH` | Steam Guard code | (empty) |

---

## Usage with Pterodactyl

### 1. Configure Your Egg

In your egg JSON, set the Docker image:

```json
"docker_images": {
    "fabriciojrsilva/steamcmd-eggs:latest": "fabriciojrsilva/steamcmd-eggs:latest"
}
```

### 2. Installation Script

The image runs as **root during installation** (required for apt-get, chown, etc.) and as **container user during runtime**.

Your installation script should:
1. Download game files to `/mnt/server`
2. Set permissions: `chown -R container:container /mnt/server` (or use UID 1000)

### 3. Startup Command

Example startup command for Arma Reforger:
```bash
cd /home/container && bash armareforger-server.sh
```

---

## Troubleshooting

### Server doesn't start automatically
- Verify the entrypoint is processing `STARTUP` correctly
- Check container logs for error messages
- Ensure the startup script exists and is executable

### SteamCMD download fails during auto-update
- Check network connectivity
- Verify Steam credentials (for non-anonymous games)
- Ensure `AUTO_UPDATE` is set correctly (0 or 1)

### Permission denied errors
- Ensure files are owned by `container:container` (UID/GID 1000)
- The installation script should set permissions correctly
- Run reinstall if permissions are corrupted

### ArmaReforgerServer binary not found
- Server was not installed properly
- Run **Reinstall** in Pterodactyl Panel using the installer image

---

## Related Documentation

- [Installer Image](../installer/README.md) - Used during installation
- [Entrypoint Script](entrypoint.sh) - Startup automation details
- [Egg Configuration](../../eggs/arma-reforger/README.md) - Full egg documentation

---

## Resources

- **GitHub Repository**: [github.com/binhotm/pterodactyl.eggs](https://github.com/binhotm/pterodactyl.eggs)
- **Pterodactyl Panel**: [pterodactyl.io](https://pterodactyl.io)

---

## Author and Support

Maintained by **Fabricio Junior Silva**

- Email: fabriciojuniorsilva@gmail.com
- GitHub: [@binhotm](https://github.com/binhotm)
- Discord: `mindisgurpe__`

---

## License

MIT License - Feel free to use, modify, and distribute.
